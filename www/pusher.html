<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Real Time Ordering System - Order Status Page</title>

    <!--[if lt IE 9]>
	    <script src="js/html5shiv.js"></script>
	    <script src="js/respond.min.js"></script>
    <![endif]-->
</head><!--/head-->
<body>
   <style>
   .table {
      display: table;
      width: 100%;
      text-align: left;
      border-top: 1px #000 solid;
   }
   .table-item {
      display: table;
      width: 100%;
      border-bottom: 1px #000 solid;
   }
   .tableHeading {
      display: table-row;
   }
   .tableRow {
      display: table-row;
   }
   .cell {
      display: table-cell;
      border-bottom: #000 1px solid;
      padding: 5px;
   }

   .cell-left {
      width: 50px;
   }
   .cell-right {
      width: 150px;
   }
   body {
      margin: 20px;
   }
   .btn-blink {
      color: transparent;
   }
  </style>
  <script src="https://js.pusher.com/3.0/pusher.min.js"></script>
  <script type="text/javascript" src="js/jquery.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script>
    var tempCounter = 2;
    var pusher = new Pusher('59d05b5b4f445c7c4573', {
      encrypted: true
    });
    var channel = pusher.subscribe('channel-one');
    channel.bind('new_order', function(data) {
      var row = "<div class=\"tableRow\"><div class=\"cell cell-left\">1</div><div class=\"cell\"><input type=\"hidden\" value=\"0\" id=\"timerId_" + tempCounter + "\">Order Item No. " + tempCounter + "</div>" +
          "<div class=\"cell cell-right\">Click to Update Status To: <button onclick=\"updateStatus('" + tempCounter + "')\" " +
          "id=\"btnOrderStatus_" + tempCounter + "\" type=\"button\" class=\"btn btn-success\">Order Received</button>" +
          "</div></div>";

      $(row).insertAfter("#tableHeading");
      var btnName = "btnOrderStatus_" + tempCounter;
      timerId = setTimeout(function() {
         $("#" + btnName).removeClass("btn-success").addClass("btn-danger");
      }, 5000);
      $("#timerId_" + tempCounter).val(timerId);
      tempCounter++;
    });

    var channel2 = pusher.subscribe('channel-one');
    channel.bind('order_update', function(data) {
      var response = JSON.parse(data.message);
      //alert("id [" + response.id + "] status [" + response.status + "]");
      $("#btnOrderStatus_" + response.id).text(response.status);
      $("#btnOrderStatus_" + response.id).removeClass("btn-danger").addClass("btn-success");
    });
  </script>
    <div id="newAlerts" class="container-fluid">
      <div class="table">
       <div id="tableHeading" class="tableHeading bg-primary">
          <div class="cell cell-left">ID</div>
          <div class="cell">Order</div>
          <div class="cell cell-right">Status</div>
      </div>
      <div class="tableRow">
          <div class="cell cell-left">1</div>
          <div class="cell">Large Fries</div>
          <div class="cell cell-right">
             Click to Update Status To:
             <button onclick="updateStatus('1')" id="btnOrderStatus_1" type="button" class="btn btn-success">Order Received</button>
          </div>
     </div>
   </div>

    </div>

    <script>
    function updateStatus(orderId) {
       var e = $("#btnOrderStatus_" + orderId);
       clearTimeout($("#timerId_" + orderId).val());
       var newStatus = "";
       var dbStatus = "";

       if (e.text() == "Order Received") {
           newStatus = "Start Processing";
           dbStatus = "ORDER_RECEIVED";
       } else if (e.text() == "Start Processing") {
           newStatus = "Order Ready for Pickup";
           dbStatus = "PROCESSING_ORDER";
       } else if (e.text() == "Order Ready for Pickup") {
           newStatus = "Order Picked Up";
           dbStatus = "READY_FOR_PICKUP";
       } else if (e.text() == "Order Picked Up") {
           newStatus = "Order Complete";
           dbStatus = "ORDER_PICKED_UP";
       } else if (e.text() == "Order Complete") {
           // no new status, remove the div from the table
           dbStatus = "ORDER_COMPLETE";
           newStatus = "Out For Delivary";
       } else {
          newStatus = "Out For Delivary";
       }

       // send ajax request to change the order status and push notification to client
       $.get("http://localhost:8080/mobile-1.0/rest/orderstatus/" + orderId + "/" + dbStatus,
           function (data) {
               newStatus = newStatus;
           }
       );
   }
    </script>
</body>
</html>
